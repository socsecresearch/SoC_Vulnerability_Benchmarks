.file "main.S"
.section .text
.balign 4
.global main

.set ALLOW_ADDRESS, 0x001FFFFF //address allowed//0x0000FFFF would trigger a store access fault exception on line sw a1, 0(a0)
main:

    //allow pmp
    li t1, ALLOW_ADDRESS     // Give user access to whole of imem and dmem. 
    srli t1, t1, 2        // Shift right logical by 2 bits (divide by 4)
    csrw pmpaddr0, t1     // Write the value of t1 to the PMP address register pmpaddr0
    li t0, 0x0708080F     // Load immediate value 0x0707070F into register t0
    csrw pmpcfg0, t0 

	li	a5,136
	csrw	mstatus,a5
	jal 	ra, goto_user_mode
	add 	a5, a5, 1    //should execute fine	
    csrw 	mstatus, a5 //should raise IIE
	add 	a5, a5, 1

goto_user_mode:
	csrw	mepc,ra
	lui	ra,0x2
	addi	ra,ra,-2048
	csrc	mstatus,ra
	mret
	add 	a5, a5, 1
.end
